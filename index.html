<!DOCTYPE html>
<html>
<head>
    <title>2014 Blue Team Cards</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(45deg, #1e3a8a, #3b82f6);
            color: white;
            padding: 30px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 40px;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5rem;
        }
        
        .header p {
            margin: 10px 0 0 0;
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .main-content {
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .nav-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .nav-btn {
            background: white;
            border: 2px solid #3b82f6;
            color: #3b82f6;
            padding: 20px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }
        
        .nav-btn:hover {
            background: #3b82f6;
            color: white;
        }
        
        .btn-title {
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .btn-desc {
            font-size: 14px;
            opacity: 0.8;
            font-weight: normal;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .back-btn {
            background: #6b7280;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .form-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            margin: 0 auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin: 20px 0;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 0 10px;
        }
        
        .btn-save {
            background: #10b981;
            color: white;
        }
        
        .btn-cancel {
            background: #6b7280;
            color: white;
        }
        
        .roster-list {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .player-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .player-item:hover {
            background: #f8f9fa;
        }
        
        .player-item:last-child {
            border-bottom: none;
        }
        
        .player-name {
            font-size: 18px;
            font-weight: bold;
        }
        
        .empty-message {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 40px;
        }
        
        .admin-section {
            margin: 30px 0;
            padding: 20px 0;
        }
        
        .admin-info-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        
        .admin-info-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #3b82f6;
        }
        
        .admin-info-item strong {
            color: #333;
            margin-right: 10px;
        }
        
        .response-item {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #10b981;
        }
        
        .response-item strong {
            display: block;
            margin-bottom: 10px;
            color: #333;
        }
        
        .response-text {
            color: #666;
            line-height: 1.5;
            font-style: italic;
        }
        
        .response-text.answered {
            font-style: normal;
            color: #333;
        }
    </style>
</head>
<body>
    <!-- Home Page -->
    <div id="homePage" class="page active">
        <div class="header">
            <h1>2014 Blue Team Cards</h1>
            <p>Goal and Corner Kick Reference Cards</p>
        </div>
        
        <div class="main-content">
            <div class="nav-buttons">
                <button class="nav-btn" onclick="showAddPlayer()">
                    <div class="btn-title">Add Player</div>
                    <div class="btn-desc">Add a new player to the roster</div>
                </button>
                
                <button class="nav-btn" onclick="showRoster()">
                    <div class="btn-title">View Roster</div>
                    <div class="btn-desc">View all players and select one to edit</div>
                </button>
                
                <button class="nav-btn" onclick="showAddCoach()">
                    <div class="btn-title">Add Coach</div>
                    <div class="btn-desc">Add coaching staff to the system</div>
                </button>
                
                <button class="nav-btn" onclick="showAdmin()">
                    <div class="btn-title">Admin</div>
                    <div class="btn-desc">Manage all player data and responses</div>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Add Player Page -->
    <div id="addPlayerPage" class="page">
        <div class="page-header">
            <h2>Add New Player</h2>
            <button class="back-btn" onclick="showHome()">← Back to Home</button>
        </div>
        
        <div class="form-container">
            <div class="form-group">
                <label>Player Name</label>
                <input type="text" id="newPlayerName" placeholder="Enter player name">
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-save" onclick="saveNewPlayer()">Save Player</button>
                <button class="btn btn-cancel" onclick="showHome()">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Roster Page -->
    <div id="rosterPage" class="page">
        <div class="page-header">
            <h2>Team Roster</h2>
            <button class="back-btn" onclick="showHome()">← Back to Home</button>
        </div>
        
        <div class="roster-list" id="rosterList">
            <div class="empty-message">No players in roster yet</div>
        </div>
    </div>
    
    <!-- Add Coach Page -->
    <div id="addCoachPage" class="page">
        <div class="page-header">
            <h2>Add New Coach</h2>
            <button class="back-btn" onclick="showHome()">← Back to Home</button>
        </div>
        
        <div class="form-container">
            <div class="form-group">
                <label>Coach Name</label>
                <input type="text" id="newCoachName" placeholder="Enter coach name">
            </div>
            
            <div class="form-group">
                <label>Role</label>
                <input type="text" id="coachRole" placeholder="Head Coach, Assistant Coach, etc.">
            </div>
            
            <div class="form-group">
                <label>Email (Optional)</label>
                <input type="email" id="coachEmail" placeholder="coach@email.com">
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-save" onclick="saveNewCoach()">Save Coach</button>
                <button class="btn btn-cancel" onclick="showHome()">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Admin Page -->
    <div id="adminPage" class="page">
        <div class="page-header">
            <h2>Admin Panel</h2>
            <button class="back-btn" onclick="showHome()">← Back to Home</button>
        </div>
        
        <div class="roster-list" id="adminRosterList">
            <div class="empty-message">No players in system yet</div>
        </div>
    </div>
    
    <!-- Admin Player Detail Page -->
    <div id="adminPlayerPage" class="page">
        <div class="page-header">
            <h2 id="adminPlayerTitle">Player Admin</h2>
            <button class="back-btn" onclick="showAdmin()">← Back to Admin</button>
        </div>
        
        <div class="form-container">
            <div class="admin-section">
                <h3 style="color: #3b82f6; border-bottom: 2px solid #3b82f6; padding-bottom: 10px;">Player Information</h3>
                <div class="admin-info-grid">
                    <div class="admin-info-item">
                        <strong>Name:</strong> <span id="adminPlayerName">-</span>
                    </div>
                    <div class="admin-info-item">
                        <strong>Position Number:</strong> <span id="adminPlayerNumber">-</span>
                    </div>
                    <div class="admin-info-item">
                        <strong>Position Name:</strong> <span id="adminPlayerPosition">-</span>
                    </div>
                </div>
            </div>
            
            <div class="admin-section">
                <h3 style="color: #3b82f6; border-bottom: 2px solid #3b82f6; padding-bottom: 10px;">Goal & Corner Kick Card Responses</h3>
                
                <div class="response-item">
                    <strong>Goal Kick: Where should you be on the pitch/field?</strong>
                    <div class="response-text" id="adminGoalKick">Not answered</div>
                </div>
                
                <div class="response-item">
                    <strong>Corner Kick (Defending): Where should you be on the pitch/field?</strong>
                    <div class="response-text" id="adminCornerKick">Not answered</div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-save" onclick="generatePlayerLink()">Generate Player Link</button>
                <button class="btn btn-save" onclick="printPlayerCard()">Print Player Card</button>
                <button class="btn" onclick="deletePlayerAdmin()" style="background: #ef4444; color: white;">Delete Player</button>
            </div>
            
            <div id="playerLinkSection" style="display: none; margin-top: 30px; padding: 20px; background: #f0f8ff; border-radius: 8px; border: 2px solid #3b82f6;">
                <h4 style="color: #3b82f6; margin: 0 0 15px 0;">Direct Player Link</h4>
                <p style="margin: 10px 0; color: #666; font-size: 14px;">Send this link to the player so they can access their page directly:</p>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="playerLinkInput" readonly style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background: white; font-family: monospace; font-size: 14px;">
                    <button onclick="copyPlayerLink()" style="padding: 10px 15px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Copy</button>
                </div>
                <p style="margin: 10px 0 0 0; color: #666; font-size: 12px;">Players can bookmark this link or access it anytime to update their information.</p>
            </div>
        </div>
    </div>
    
    <!-- Admin Coach Detail Page -->
    <div id="adminCoachPage" class="page">
        <div class="page-header">
            <h2 id="adminCoachTitle">Coach Admin</h2>
            <button class="back-btn" onclick="showAdmin()">← Back to Admin</button>
        </div>
        
        <div class="form-container">
            <div class="admin-section">
                <h3 style="color: #10b981; border-bottom: 2px solid #10b981; padding-bottom: 10px;">Coach Information</h3>
                <div class="admin-info-grid">
                    <div class="admin-info-item" style="border-left: 4px solid #10b981;">
                        <strong>Name:</strong> <span id="adminCoachName">-</span>
                    </div>
                    <div class="admin-info-item" style="border-left: 4px solid #10b981;">
                        <strong>Role:</strong> <span id="adminCoachRole">-</span>
                    </div>
                    <div class="admin-info-item" style="border-left: 4px solid #10b981;">
                        <strong>Email:</strong> <span id="adminCoachEmail">-</span>
                    </div>
                    <div class="admin-info-item" style="border-left: 4px solid #10b981;">
                        <strong>Added Date:</strong> <span id="adminCoachAdded">-</span>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-save" onclick="showCoachEditPage()">Edit Coach</button>
                <button class="btn" onclick="deleteCoachAdmin()" style="background: #ef4444; color: white;">Delete Coach</button>
            </div>
        </div>
    </div>
    
    <!-- Coach Edit Page -->
    <div id="coachPage" class="page">
        <div class="page-header">
            <h2 id="coachPageTitle">Coach Details</h2>
            <button class="back-btn" onclick="showAdminCoach()">← Back to Coach Admin</button>
        </div>
        
        <div class="form-container">
            <div class="form-group">
                <label>Coach Name</label>
                <input type="text" id="coachName" placeholder="Enter coach name">
            </div>
            
            <div class="form-group">
                <label>Role</label>
                <input type="text" id="coachRoleEdit" placeholder="Head Coach, Assistant Coach, etc.">
            </div>
            
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="coachEmailEdit" placeholder="coach@email.com">
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-save" onclick="saveCoachDetails()">Save Changes</button>
                <button class="btn btn-cancel" onclick="showAdminCoach()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Player Page -->
    <div id="playerPage" class="page">
        <div class="page-header">
            <h2 id="playerPageTitle">Player Details</h2>
            <button class="back-btn" onclick="showRoster()">← Back to Roster</button>
        </div>
        
        <div class="form-container">
            <div class="form-group">
                <label>Player Name</label>
                <input type="text" id="playerName" readonly style="background: #f5f5f5;">
            </div>
            
            <div class="form-group">
                <label>Position Number</label>
                <input type="text" id="playerNumber" placeholder="Enter position number (1-11)">
            </div>
            
            <div class="form-group">
                <label>Position Name</label>
                <input type="text" id="playerPosition" placeholder="Enter position name">
            </div>
            
            <div style="margin: 30px 0;">
                <h3 style="color: #333; margin-bottom: 15px;">Available Questionnaires</h3>
                <button class="nav-btn" onclick="showGoalCornerCard()" style="margin: 0; width: 100%;">
                    <div class="btn-title">Goal & Corner Kick Card</div>
                    <div class="btn-desc">Set positioning for goal kicks and corner kick defense</div>
                </button>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-save" onclick="savePlayerDetails()">Save Position Info</button>
                <button class="btn btn-cancel" onclick="showRoster()">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Player Read-Only Page -->
    <div id="playerReadOnlyPage" class="page">
        <div class="page-header">
            <h2 id="readOnlyPlayerTitle">Player Card</h2>
            <button class="back-btn" onclick="showRoster()">← Back to Roster</button>
        </div>
        
        <div class="form-container">
            <div class="admin-section">
                <h3 style="color: #3b82f6; border-bottom: 2px solid #3b82f6; padding-bottom: 10px;">Player Information</h3>
                <div class="admin-info-grid">
                    <div class="admin-info-item">
                        <strong>Name:</strong> <span id="readOnlyPlayerName">-</span>
                    </div>
                    <div class="admin-info-item">
                        <strong>Position Number:</strong> <span id="readOnlyPlayerNumber">-</span>
                    </div>
                    <div class="admin-info-item">
                        <strong>Position Name:</strong> <span id="readOnlyPlayerPosition">-</span>
                    </div>
                </div>
            </div>
            
            <div class="admin-section">
                <h3 style="color: #3b82f6; border-bottom: 2px solid #3b82f6; padding-bottom: 10px;">Goal & Corner Kick Card Responses</h3>
                
                <div class="response-item">
                    <strong>Goal Kick: Where should you be on the pitch/field?</strong>
                    <div class="response-text" id="readOnlyGoalKick">Not answered yet</div>
                </div>
                
                <div class="response-item">
                    <strong>Corner Kick (Defending): Where should you be on the pitch/field?</strong>
                    <div class="response-text" id="readOnlyCornerKick">Not answered yet</div>
                </div>
            </div>
            
            <!-- Review Status Section -->
            <div class="admin-section" id="reviewSection">
                <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; margin: 20px 0;">
                    <div id="reviewStatus" style="margin-bottom: 15px; font-weight: bold;"></div>
                    <button id="reviewButton" class="btn" onclick="togglePlayerReview()" style="background: #10b981; color: white;">Mark as Reviewed</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Goal & Corner Kick Card Page -->
    <div id="goalCornerPage" class="page">
        <div class="page-header">
            <h2 id="cardPageTitle">Goal & Corner Kick Card</h2>
            <button class="back-btn" onclick="showPlayerPage()">← Back to Player</button>
        </div>
        
        <div class="form-container">
            <div class="form-group">
                <label>Goal Kick: Where should you be on the pitch/field?</label>
                <textarea id="goalKickAnswer" rows="4" placeholder="Describe your positioning during goal kicks..." style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box; resize: vertical;"></textarea>
            </div>
            
            <div class="form-group">
                <label>Corner Kick (Defending): Where should you be on the pitch/field?</label>
                <textarea id="cornerKickAnswer" rows="4" placeholder="Describe your positioning when defending corner kicks..." style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box; resize: vertical;"></textarea>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-save" onclick="saveCardAnswers()">Save Answers</button>
                <button class="btn btn-cancel" onclick="showPlayerPage()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBcH2sW8OR2IkL5MKWSvP8VRKRQeP__i0",
            authDomain: "blue-team-cards.firebaseapp.com",
            projectId: "blue-team-cards",
            storageBucket: "blue-team-cards.firebasestorage.app",
            messagingSenderId: "100271159843",
            appId: "1:100271159843:web:277972689ce7117bfbe45"
        };
        
        // Initialize Firebase
        let db;
        let firebaseReady = false;
        
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            firebaseReady = true;
            console.log('Firebase connected successfully');
        } catch (error) {
            console.log('Firebase not configured yet, using local storage');
            firebaseReady = false;
        }
        
        // Initialize EmailJS
        emailjs.init("YOUR_EMAILJS_USER_ID"); // Replace with your EmailJS User ID
        
        var players = [];
        var coaches = [];
        var currentPlayerIndex = -1;
        var currentCoachIndex = -1; 
        
        // Email notification function
        async function sendUpdateNotification(playerName, updateType) {
            if (coaches.length === 0) {
                console.log('No coaches to notify');
                return;
            }
            
            const coachEmails = coaches.filter(coach => coach.email).map(coach => coach.email);
            if (coachEmails.length === 0) {
                console.log('No coach emails available');
                return;
            }
            
            const templateParams = {
                player_name: playerName,
                update_type: updateType,
                team_name: '2014 Blue Team',
                to_email: coachEmails.join(', '),
                timestamp: new Date().toLocaleString()
            };
            
            try {
                await emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', templateParams);
                console.log('Email notification sent successfully');
            } catch (error) {
                console.error('Failed to send email notification:', error);
            }
        }

        // Data persistence functions
        async function savePlayersToCloud() {
            if (!firebaseReady) {
                // Fallback to localStorage
                localStorage.setItem('soccerPlayers', JSON.stringify(players));
                localStorage.setItem('soccerCoaches', JSON.stringify(coaches));
                return;
            }
            
            try {
                await db.collection('teams').doc('2014-blue').set({
                    players: players,
                    coaches: coaches,
                    lastUpdated: new Date()
                });
                console.log('Data saved to cloud');
            } catch (error) {
                console.error('Error saving to cloud:', error);
                // Fallback to localStorage
                localStorage.setItem('soccerPlayers', JSON.stringify(players));
                localStorage.setItem('soccerCoaches', JSON.stringify(coaches));
            }
        }
        
        async function loadPlayersFromCloud() {
            if (!firebaseReady) {
                // Fallback to localStorage
                const savedPlayers = localStorage.getItem('soccerPlayers');
                const savedCoaches = localStorage.getItem('soccerCoaches');
                if (savedPlayers) players = JSON.parse(savedPlayers);
                if (savedCoaches) coaches = JSON.parse(savedCoaches);
                return;
            }
            
            try {
                const doc = await db.collection('teams').doc('2014-blue').get();
                if (doc.exists) {
                    const data = doc.data();
                    players = data.players || [];
                    coaches = data.coaches || [];
                    console.log('Data loaded from cloud');
                } else {
                    console.log('No cloud data found, starting fresh');
                }
            } catch (error) {
                console.error('Error loading from cloud:', error);
                // Fallback to localStorage
                const savedPlayers = localStorage.getItem('soccerPlayers');
                const savedCoaches = localStorage.getItem('soccerCoaches');
                if (savedPlayers) players = JSON.parse(savedPlayers);
                if (savedCoaches) coaches = JSON.parse(savedCoaches);
            }
        }
        
        // Navigation functions
        function showHome() {
            hideAllPages();
            document.getElementById('homePage').className = 'page active';
        }
        
        function showAddPlayer() {
            hideAllPages();
            document.getElementById('addPlayerPage').className = 'page active';
            document.getElementById('newPlayerName').value = '';
        }
        
        function showRoster() {
            hideAllPages();
            document.getElementById('rosterPage').className = 'page active';
            displayRoster();
        }
        
        function showAddCoach() {
            hideAllPages();
            document.getElementById('addCoachPage').className = 'page active';
            document.getElementById('newCoachName').value = '';
            document.getElementById('coachRole').value = '';
            document.getElementById('coachEmail').value = '';
        }
        
        function showAdmin() {
            hideAllPages();
            document.getElementById('adminPage').className = 'page active';
            displayAdminRoster();
        }
        
        function showAdminPlayer() {
            hideAllPages();
            document.getElementById('adminPlayerPage').className = 'page active';
            if (currentPlayerIndex >= 0) {
                loadAdminPlayerDetails();
            }
        }
 
        function showAdminCoach() {
            hideAllPages();
            document.getElementById('adminCoachPage').className = 'page active';
            if (currentCoachIndex >= 0) {
                loadAdminCoachDetails();
            }
        }        
        
        function showPlayerPage() {
            hideAllPages();
            document.getElementById('playerPage').className = 'page active';
            if (currentPlayerIndex >= 0) {
                loadPlayerDetails();
            }
        }

        function showPlayerReadOnlyPage() {
            hideAllPages();
            document.getElementById('playerReadOnlyPage').className = 'page active';
            if (currentPlayerIndex >= 0) {
                loadPlayerReadOnlyDetails();
            }
        }        

        function showCoachPage() {
            hideAllPages();
            document.getElementById('coachPage').className = 'page active';
            if (currentCoachIndex >= 0) {
                loadCoachDetails();
            }
        }

        function loadAdminCoachDetails() {
            var coach = coaches[currentCoachIndex];
            
            document.getElementById('adminCoachTitle').textContent = 'Admin: ' + coach.name;
            document.getElementById('adminCoachName').textContent = coach.name;
            document.getElementById('adminCoachRole').textContent = coach.role;
            document.getElementById('adminCoachEmail').textContent = coach.email || 'No email provided';
            document.getElementById('adminCoachAdded').textContent = coach.addedDate || 'Unknown';
        }

        function loadCoachDetails() {
            var coach = coaches[currentCoachIndex];
            document.getElementById('coachPageTitle').textContent = coach.name + ' - Coach Details';
            document.getElementById('coachName').value = coach.name;
            document.getElementById('coachRoleEdit').value = coach.role;
            document.getElementById('coachEmailEdit').value = coach.email || '';
        }

        function showGoalCornerCard() {
            hideAllPages();
            document.getElementById('goalCornerPage').className = 'page active';
            if (currentPlayerIndex >= 0) {
                loadCardAnswers();
            }
        }
        
        function hideAllPages() {
            var pages = document.getElementsByClassName('page');
            for (var i = 0; i < pages.length; i++) {
                pages[i].className = 'page';
            }
        }
        
        // Coach functions
        async function saveNewCoach() {
            var name = document.getElementById('newCoachName').value.trim();
            var role = document.getElementById('coachRole').value.trim();
            var email = document.getElementById('coachEmail').value.trim();
            
            if (!name) {
                alert('Please enter a coach name');
                return;
            }
            
            var newCoach = {
                name: name,
                role: role || 'Coach',
                email: email,
                addedDate: new Date().toISOString().split('T')[0]
            };
            
            coaches.push(newCoach);
            await savePlayersToCloud();
            alert('Coach "' + name + '" added successfully!');
            showHome();
        }

        async function deleteCoachAdmin() {
            var coach = coaches[currentCoachIndex];
            if (confirm('Are you sure you want to delete coach ' + coach.name + '? This cannot be undone.')) {
                coaches.splice(currentCoachIndex, 1);
                await savePlayersToCloud();
                alert('Coach deleted successfully');
                showAdmin();
            }
        }
        
        // Player functions
        async function saveNewPlayer() {
            var name = document.getElementById('newPlayerName').value.trim();
            
            if (!name) {
                alert('Please enter a player name');
                return;
            }
            
            var newPlayer = {
                name: name,
                number: '',
                position: '',
                goalKick: '',
                cornerKick: ''
            };
            
            players.push(newPlayer);
            await savePlayersToCloud();
            alert('Player "' + name + '" added successfully!');
            showHome();
        }
        
        function displayRoster() {
            var container = document.getElementById('rosterList');
            
            if (players.length === 0 && coaches.length === 0) {
                container.innerHTML = '<div class="empty-message">No players or coaches in roster yet</div>';
                return;
            }
            
            var html = '';
            
            // Coaches Section
            if (coaches.length > 0) {
                html += '<div style="margin-bottom: 30px;">';
                html += '<h3 style="color: #10b981; border-bottom: 2px solid #10b981; padding-bottom: 10px; margin-bottom: 20px;">Coaches</h3>';
                
                for (var i = 0; i < coaches.length; i++) {
                    var coach = coaches[i];
                    html += '<div class="player-item" style="cursor: default;">';
                    html += '<div>';
                    html += '<div class="player-name" style="color: #10b981;">' + coach.name + '</div>';
                    html += '<div style="color: #10b981; font-weight: bold;">' + coach.role + '</div>';
                    html += '</div>';
                    html += '</div>';
                }
                html += '</div>';
            }
            
            // Players Section
            if (players.length > 0) {
                html += '<div>';
                html += '<h3 style="color: #3b82f6; border-bottom: 2px solid #3b82f6; padding-bottom: 10px; margin-bottom: 20px;">Players</h3>';
                
                for (var i = 0; i < players.length; i++) {
                    var player = players[i];
                    
                    // Determine player status
                    var hasBasicInfo = player.number && player.position;
                    var hasResponses = player.goalKick || player.cornerKick;
                    var needsReview = player.needsReview || false;
                    
                    var statusColor = '#3b82f6'; // Default blue
                    var statusIndicator = '';
                    
                    // Red if missing basic info or no responses
                    if (!hasBasicInfo || !hasResponses) {
                        statusColor = '#ef4444'; // Red
                        statusIndicator = '🔴 ';
                    }
                    // Orange if needs review
                    else if (needsReview) {
                        statusColor = '#f59e0b'; // Orange
                        statusIndicator = '🟡 ';
                    }
                    // Green if all complete and reviewed
                    else {
                        statusColor = '#10b981'; // Green
                        statusIndicator = '🟢 ';
                    }
                    
                    html += '<div class="player-item" onclick="selectPlayerReadOnly(' + i + ')" style="border-left: 4px solid ' + statusColor + ';">';
                    html += '<div>';
                    html += '<div class="player-name">' + statusIndicator + player.name + '</div>';
                    
                    // Status line
                    var statusLine = '';
                    if (player.number && player.position) {
                        statusLine += '#' + player.number + ' - ' + player.position;
                    } else {
                        statusLine += 'Position not set';
                    }
                    
                    // Add status indicators
                    var statusMessages = [];
                    if (!hasBasicInfo) {
                        statusMessages.push('Missing position info');
                    }
                    if (!hasResponses) {
                        statusMessages.push('No card responses');
                    }
                    if (needsReview) {
                        statusMessages.push('Needs review');
                    }
                    if (hasBasicInfo && hasResponses && !needsReview) {
                        statusMessages.push('Complete & reviewed');
                    }
                    
                    if (statusMessages.length > 0) {
                        statusLine += ' • ' + statusMessages.join(' • ');
                    }
                    
                    html += '<div style="color: ' + statusColor + '; font-weight: bold; font-size: 14px;">' + statusLine + '</div>';
                    html += '</div>';
                    html += '<div style="color: ' + statusColor + ';">→</div>';
                    html += '</div>';
                }
                html += '</div>';
            }
            
            container.innerHTML = html;
        }
        
        function selectCoach(index) {
            currentPlayerIndex = -1; // Reset player index
            currentCoachIndex = index;
            showCoachPage();
        }

        function selectPlayer(index) {
            currentPlayerIndex = index;
            showPlayerPage();
        }

        function selectPlayerReadOnly(index) {
            currentPlayerIndex = index;
            showPlayerReadOnlyPage();
        }        
        
        function loadPlayerDetails() {
            var player = players[currentPlayerIndex];
            document.getElementById('playerPageTitle').textContent = player.name + ' - Details';
            document.getElementById('playerName').value = player.name;
            document.getElementById('playerNumber').value = player.number;
            document.getElementById('playerPosition').value = player.position;
        }
        
        function loadPlayerReadOnlyDetails() {
            var player = players[currentPlayerIndex];
            
            document.getElementById('readOnlyPlayerTitle').textContent = player.name + ' - Player Card';
            document.getElementById('readOnlyPlayerName').textContent = player.name;
            document.getElementById('readOnlyPlayerNumber').textContent = player.number || 'Not set';
            document.getElementById('readOnlyPlayerPosition').textContent = player.position || 'Not set';
            
            var goalKickElement = document.getElementById('readOnlyGoalKick');
            var cornerKickElement = document.getElementById('readOnlyCornerKick');
            
            if (player.goalKick) {
                goalKickElement.textContent = player.goalKick;
                goalKickElement.className = 'response-text answered';
            } else {
                goalKickElement.textContent = 'Not answered yet';
                goalKickElement.className = 'response-text';
            }
            
            if (player.cornerKick) {
                cornerKickElement.textContent = player.cornerKick;
                cornerKickElement.className = 'response-text answered';
            } else {
                cornerKickElement.textContent = 'Not answered yet';
                cornerKickElement.className = 'response-text';
            }

                // Update review status display
            updateReviewStatusDisplay();
        }

        function updateReviewStatusDisplay() {
            var player = players[currentPlayerIndex];
            var reviewStatusElement = document.getElementById('reviewStatus');
            var reviewButtonElement = document.getElementById('reviewButton');
            var reviewSectionElement = document.getElementById('reviewSection');
            
            // Only show review section if player has responses
            var hasResponses = player.goalKick || player.cornerKick;
            if (!hasResponses) {
                reviewSectionElement.style.display = 'none';
                return;
            }
            
            reviewSectionElement.style.display = 'block';
            
            if (player.needsReview) {
                reviewStatusElement.textContent = '🟡 Responses need coach review';
                reviewStatusElement.style.color = '#f59e0b';
                reviewButtonElement.textContent = 'Mark as Reviewed';
                reviewButtonElement.style.background = '#10b981';
            } else {
                reviewStatusElement.textContent = '✅ Responses have been reviewed by coach';
                reviewStatusElement.style.color = '#10b981';
                reviewButtonElement.textContent = 'Mark as Needs Review';
                reviewButtonElement.style.background = '#f59e0b';
            }
        }

        async function togglePlayerReview() {
            var player = players[currentPlayerIndex];
            
            // Toggle the review status
            player.needsReview = !player.needsReview;
            
            await savePlayersToCloud();
            
            // Update the display
            updateReviewStatusDisplay();
            
            // Show confirmation
            if (player.needsReview) {
                alert('Player marked as needing review');
            } else {
                alert('Player marked as reviewed - great job!');
            }
        }

        async function savePlayerDetails() {
            var number = document.getElementById('playerNumber').value.trim();
            var position = document.getElementById('playerPosition').value.trim();
            
            if (number && position) {
                players[currentPlayerIndex].number = number;
                players[currentPlayerIndex].position = position;
                await savePlayersToCloud();
                
                // Send email notification
                await sendUpdateNotification(players[currentPlayerIndex].name, 'position information');
                
                alert('Position information saved!');
                showRoster();
            } else {
                alert('Please fill in both position number and position name');
            }
        }
        
        function loadCardAnswers() {
            var player = players[currentPlayerIndex];
            document.getElementById('cardPageTitle').textContent = player.name + ' - Goal & Corner Kick Card';
            document.getElementById('goalKickAnswer').value = player.goalKick;
            document.getElementById('cornerKickAnswer').value = player.cornerKick;
        }
        
        async function saveCardAnswers() {
            var goalKick = document.getElementById('goalKickAnswer').value.trim();
            var cornerKick = document.getElementById('cornerKickAnswer').value.trim();
            
            // Show loading state
            var saveBtn = document.querySelector('#goalCornerPage .btn-save');
            var originalText = saveBtn.textContent;
            saveBtn.textContent = 'Uploading...';
            saveBtn.disabled = true;
            
            try {
                players[currentPlayerIndex].goalKick = goalKick;
                players[currentPlayerIndex].cornerKick = cornerKick;
                
                // Mark as needing review if responses were provided
                if (goalKick || cornerKick) {
                    players[currentPlayerIndex].needsReview = true;
                }
                
                await savePlayersToCloud();
                
                // Send email notification
                await sendUpdateNotification(players[currentPlayerIndex].name, 'Goal & Corner Kick questionnaire');
                
                // Show success message
                alert('Answers uploaded successfully!');
                showPlayerPage();
                
            } catch (error) {
                console.error('Error saving answers:', error);
                alert('Error uploading answers. Please try again.');
                
                // Reset button
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            }
        }
        
        // Admin functions
        function displayAdminRoster() {
            var container = document.getElementById('adminRosterList');
            
            if (players.length === 0 && coaches.length === 0) {
                container.innerHTML = '<div class="empty-message">No players or coaches in system yet</div>';
                return;
            }
            
            var html = '';
            
            // Display coaches first
            for (var i = 0; i < coaches.length; i++) {
                var coach = coaches[i];
                html += '<div class="player-item" onclick="selectAdminCoach(' + i + ')">';
                html += '<div>';
                html += '<div class="player-name">' + coach.name + ' (Coach)</div>';
                html += '<div style="color: #666; font-size: 14px;">' + coach.role + ' • ' + (coach.email || 'No email') + '</div>';
                html += '</div>';
                html += '<div style="color: #10b981;">→</div>';
                html += '</div>';
            }
            
            // Display players
            for (var i = 0; i < players.length; i++) {
                var player = players[i];
                var hasResponses = player.goalKick || player.cornerKick;
                
                html += '<div class="player-item" onclick="selectAdminPlayer(' + i + ')">';
                html += '<div>';
                html += '<div class="player-name">' + player.name + '</div>';
                
                var statusLine = '';
                if (player.number && player.position) {
                    statusLine += '#' + player.number + ' - ' + player.position;
                } else {
                    statusLine += 'Position not set';
                }
                
                if (hasResponses) {
                    statusLine += ' • Has responses';
                } else {
                    statusLine += ' • No responses';
                }
                
                html += '<div style="color: #666; font-size: 14px;">' + statusLine + '</div>';
                html += '</div>';
                html += '<div style="color: #3b82f6;">→</div>';
                html += '</div>';
            }
            
            container.innerHTML = html;
        }
        
        function selectAdminPlayer(index) {
            currentPlayerIndex = index;
            showAdminPlayer();
        }

        function selectAdminCoach(index) {
            currentCoachIndex = index;
            currentPlayerIndex = -1; // Reset player index
            showAdminCoach();
        }
        
        function loadAdminPlayerDetails() {
            var player = players[currentPlayerIndex];
            
            document.getElementById('adminPlayerTitle').textContent = 'Admin: ' + player.name;
            document.getElementById('adminPlayerName').textContent = player.name;
            document.getElementById('adminPlayerNumber').textContent = player.number || 'Not set';
            document.getElementById('adminPlayerPosition').textContent = player.position || 'Not set';
            
            var goalKickElement = document.getElementById('adminGoalKick');
            var cornerKickElement = document.getElementById('adminCornerKick');
            
            if (player.goalKick) {
                goalKickElement.textContent = player.goalKick;
                goalKickElement.className = 'response-text answered';
            } else {
                goalKickElement.textContent = 'Not answered';
                goalKickElement.className = 'response-text';
            }
            
            if (player.cornerKick) {
                cornerKickElement.textContent = player.cornerKick;
                cornerKickElement.className = 'response-text answered';
            } else {
                cornerKickElement.textContent = 'Not answered';
                cornerKickElement.className = 'response-text';
            }
        }
        
        function printPlayerCard() {
            alert('Print functionality coming soon!');
        }
        
        async function deletePlayerAdmin() {
            var player = players[currentPlayerIndex];
            if (confirm('Are you sure you want to delete ' + player.name + '? This cannot be undone.')) {
                players.splice(currentPlayerIndex, 1);
                await savePlayersToCloud();
                alert('Player deleted successfully');
                showAdmin();
            }
        }
        
        function showCoachEditPage() {
            hideAllPages();
            document.getElementById('coachPage').className = 'page active';
            if (currentCoachIndex >= 0) {
                loadCoachDetails();
            }
        }

        async function saveCoachDetails() {
            var name = document.getElementById('coachName').value.trim();
            var role = document.getElementById('coachRoleEdit').value.trim();
            var email = document.getElementById('coachEmailEdit').value.trim();
            
            if (!name) {
                alert('Please enter a coach name');
                return;
            }
            
            if (!role) {
                alert('Please enter a role');
                return;
            }
            
            coaches[currentCoachIndex].name = name;
            coaches[currentCoachIndex].role = role;
            coaches[currentCoachIndex].email = email;
            
            await savePlayersToCloud();
            alert('Coach information updated successfully!');
            showAdminCoach();
        }

        function generatePlayerLink() {
            var player = players[currentPlayerIndex];
            var baseUrl = window.location.href;
            
            // Handle different URL scenarios
            if (baseUrl.includes('about:srcdoc') || baseUrl.includes('blob:')) {
                // When running in embedded environment, create a generic placeholder
                baseUrl = 'https://yourserver.com/soccer-cards.html';
            } else {
                // Remove any existing query params from real URLs
                baseUrl = baseUrl.split('?')[0];
            }
            
            var playerLink = baseUrl + '?player=' + encodeURIComponent(player.name) + '&id=' + currentPlayerIndex;
            
            document.getElementById('playerLinkInput').value = playerLink;
            document.getElementById('playerLinkSection').style.display = 'block';
            
            // Show additional instruction for embedded environment
            if (window.location.href.includes('about:srcdoc') || window.location.href.includes('blob:')) {
                var instruction = document.createElement('p');
                instruction.style.cssText = 'margin: 10px 0; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; color: #856404; font-size: 12px;';
                instruction.innerHTML = '<strong>Note:</strong> Replace "yourserver.com/soccer-cards.html" with your actual website URL when you deploy this file.';
                document.getElementById('playerLinkSection').appendChild(instruction);
            }
        }
        
        function copyPlayerLink() {
            var linkInput = document.getElementById('playerLinkInput');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                document.execCommand('copy');
                alert('Link copied to clipboard!');
            } catch (err) {
                alert('Unable to copy automatically. Please select and copy the link manually.');
            }
        }
        
        // Check for direct player link on page load
        function checkDirectPlayerAccess() {
            var urlParams = new URLSearchParams(window.location.search);
            var playerName = urlParams.get('player');
            var playerId = urlParams.get('id');
            
            if (playerName && playerId !== null) {
                var index = parseInt(playerId);
                if (index >= 0 && index < players.length && players[index].name === playerName) {
                    currentPlayerIndex = index;
                    
                    // Hide the home page navigation for direct player access
                    hideAllPages();
                    document.getElementById('playerPage').className = 'page active';
                    loadPlayerDetails();
                    
                    // Modify the player page for direct access
                    document.getElementById('playerPageTitle').textContent = players[index].name + ' - Your Soccer Card';
                    
                    // Change back button to a simple "Done" message
                    var backBtn = document.querySelector('#playerPage .back-btn');
                    backBtn.textContent = '✓ Done';
                    backBtn.onclick = function() {
                        if (confirm('Are you finished updating your information?')) {
                            window.close();
                            // Fallback message if window.close() doesn't work
                            setTimeout(function() {
                                alert('Your information has been saved! You can close this tab or bookmark this page to return anytime.');
                            }, 100);
                        }
                    };
                    
                    // Hide the header on home page so players can't navigate there
                    document.getElementById('homePage').style.display = 'none';
                    
                    // Also modify the goal/corner card page back button
                    var cardBackBtn = document.querySelector('#goalCornerPage .back-btn');
                    cardBackBtn.onclick = function() {
                        hideAllPages();
                        document.getElementById('playerPage').className = 'page active';
                    };
                    
                } else {
                    alert('Invalid player link. Please contact your coach for a new link.');
                }
            }
        }
        
        // Load players and check for direct access when page loads
        window.addEventListener('load', async function() {
            await loadPlayersFromCloud();
            checkDirectPlayerAccess();
            
            // Refresh displays if we're on a page that shows players
            if (document.getElementById('rosterPage').classList.contains('active')) {
                displayRoster();
            }
            if (document.getElementById('adminPage').classList.contains('active')) {
                displayAdminRoster();
            }
        });
    </script>
</body>
</html>
